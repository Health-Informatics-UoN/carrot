import { Callout, Steps, Tabs, Table, Td, Th, Tr } from "nextra/components";

# Azure Deployment Steps

This page will guide you through some high-level steps required to deploy Carrot Mapper on Azure.

## Resources Creation

Let's start by create some Azure resource for Carrot:

<Steps>

### Resource group

If you didn't do so, create a resource group which holds related resources for an Azure solution.

Choose a suitable `Subscription`, `Region` and a name for your `Resource group`.

### Web apps

Two web apps will need creating: One for Backend and another for Frontend.

**Basics**

Choose a suitable `Subscription`, `Resource group`, `Region`, `Pricing plan`, and a name for your Web app.

Publish mode and Operating system should be `Container` and `Linux`, respectively.

**Container**

Choose `Other container registries` as `Image source`.

For `Docker hub options`, setup as below:

<Tabs items={['Frontend app', 'Backend app']}>
  <Tabs.Tab>
  Access type: `Public`

Registry server URL:

```bash
ghcr.io/health-informatics-uon
```

Image and tag:

```bash
carrot/frontend:<tag>
```

You can choose a version of this container by using the tag for the image. Look for available tags [here](https://github.com/Health-Informatics-UoN/carrot-mapper/pkgs/container/carrot%2Ffrontend).

  </Tabs.Tab>
  <Tabs.Tab>

Access type: `Public`

Registry server URL:

```bash
ghcr.io/health-informatics-uon
```

Image and tag:

```bash
carrot/backend:<tag>
```

You can choose a version of this container by using the tag for the image. Look for available tags [here](https://github.com/Health-Informatics-UoN/carrot-mapper/pkgs/container/carrot%2Fbackend).

  </Tabs.Tab>
</Tabs>

**Networking**: As default.

**Monitor + Secure**: We recommend Application Insights to be enabled.

**Tags**: Give name and value for the web app's tag, if needed.

### Function app

Choose `App service` when prompted.

**Basics**

Choose a suitable `Subscription`, `Resource group`, `Region`, `Pricing plan`, and a name for your Function app.

Select `Container Image` as the mode of deploying.

**Storage**: Choose or create an Azure storage where the Function app will store its Blobs and Queues.

**Networking**: As default.

**Monitor + Secure**: We recommend Application Insights to be enabled.

**Tags**: Give name and value for the web app's tag, if needed.

**Container Image**: A default image will be used as you create a function app. Therefore, after the app being deployed you must change this image by doing so:
  <div>
    1. Access the newly created Function app.
    2. Under tab `Deployment`, choose `Deployment center`.
    3. Choose `Private Registry` as Registry source.
    4. Change Server URL to: `https://ghcr.io`.
    5. Change Full Image Name and Tag to: `health-informatics-uon/carrot/workers:<tag>`. Look for available tags [here](https://github.com/Health-Informatics-UoN/carrot-mapper/pkgs/container/carrot%2Fworkers).
    6. Save the Settings.
  </div>

### PostgreSQL Database

If you didn't have one, create a PostgreSQL Database on Azure.

Follow prompted steps to create a suitable Database for Carrot.

### Data Factory

Data factory is useful when creating workflows/scripts to load and manage data on Azure storage and Azure database.

Create one following the prompted steps.

### Key vault

Key vault is highly recommended to keep secrets and keys for functioning Carrot safe. If you didn't have one, create a Key Vault following the prompted steps on Azure.

</Steps>

## Preparation

You will need to prepare your database and storage before configure other apps.

<Steps>

### Database

Using Data factory or other ways to create a schema named `omop` in your database, then load there the vocabularies, which you would like to be in Carrot, downloaded from [Athena](https://athena.ohdsi.org/). The guide for downloading can be found [here](https://github.com/OHDSI/Vocabulary-v5.0/wiki/General-Structure,-Download-and-Use).

### Storage

Navigate to the Storage account linked with you Function app, then `Data storage`.
Add these `Queues` and `Containers`:

<Tabs items={['Queues', 'Blob Containers']}>
  <Tabs.Tab>

```
Queue for Rules actions triggers, e.g., `rules`
Queue for Mapping rules exports, e.g., `rules-exports`
Queue for Scan reports uploads, e.g., `uploadreports`
```

Note: Queues names should match with `RULES_QUEUE_NAME` `RULES_FILE_QUEUE_NAME` `WORKERS_UPLOAD_NAME` in `Azure functions`.

  </Tabs.Tab>
  <Tabs.Tab>

```
Container for ScanReport blobs, e.g., `scan-reports`
Container for Data dictionary blobs, e.g., `data-dictionaries`
Container for Mapping rules files, e.g., `rules-exports`
```

  </Tabs.Tab>
</Tabs>

</Steps>

## Configuration

Below are some important steps to configure created apps making them working together smoothly. More details and Azure examples can be found on [Configuration](/mapper/dev_guide/deployment/configuration) section.

<Steps>

### Backend app

Navigate to `Environment variables` section under `Settings` of your Backend web app, then add the variables below:

<Table>
  <thead>
    <Tr>
      <Th>Key</Th>
      <Th>Description</Th>
    </Tr>
  </thead>
  <tbody>
    <Tr>
      <Td>`FRONTEND_URL`</Td>
      <Td>The URL of your Frontend app.</Td>
    </Tr>
    <Tr>
      <Td>`ALLOWED_HOSTS`</Td>
      <Td>
        A list of strings representing the host/domain names that this Django
        site can serve. Put here the URL of your Backend app and `localhost`.
      </Td>
    </Tr>
    <Tr>
      <Td>`DB_ENGINE`</Td>
      <Td>
        The database backend to use. Put here `django.db.backends.postgresql`.
      </Td>
    </Tr>
    <Tr>
      <Td>`DB_HOST` `DB_PORT` `DB_NAME` `DB_USER` `DB_PASSWORD`</Td>
      <Td>
        These settings (`port`, `host`, `name`, `user`, `password`) are required
        for PostgreSQL database connection. Put the details based on the setting
        of your Database. `DB_PASSWORD` is recommended to be put in the Key
        Vault.
      </Td>
    </Tr>
    <Tr>
      <Td>`WORKERS_URL`</Td>
      <Td>
        The URL of `Workers` (Azure functions) service which `Backend` should
        connect to.
      </Td>
    </Tr>
    <Tr>
      <Td>`WORKERS_UPLOAD_NAME` `WORKERS_RULES_EXPORT_NAME`</Td>
      <Td>
        Name of queues in Azurite that `Workers` send messages about ScanReport
        uploads and Mapping Rules exports, respectively. These should match with
        the queues for ScanReport uploads and Mapping rules file exports in
        Azure storage.
      </Td>
    </Tr>
    <Tr>
      <Td>`WORKERS_RULES_KEY`</Td>
      <Td>
        The key to authorise the request sent to `Workers` from `Backend`. Get
        this value by navigating to the Function app, then inside `App keys`
        under `Functions`, copy the `_master` key. It is recommended to put this
        in the Key Vault.
      </Td>
    </Tr>
    <Tr>
      <Td>`STORAGE_CONN_STRING`</Td>
      <Td>
        The key to connect Backend and Azure local storage. Get this value by
        navigating to the Azure storage, then inside `Access keys` under
        `Security + Networking`, copy the `Connection string`. It is recommended
        to put this in the Key Vault.
      </Td>
    </Tr>
    <Tr>
      <Td>`SECRET_KEY`</Td>
      <Td>
        A secret key for a particular Django installation. Choose a complex key
        for this. It is recommended to put this in the Key Vault.
      </Td>
    </Tr>
    <Tr>
      <Td>`SIGNING_KEY`</Td>
      <Td>
        A key required in JWT token generation process for Next Auth. Choose a
        complex key for this. It is recommended to put this in the Key Vault.
      </Td>
    </Tr>
  </tbody>
</Table>

**Before restarting the application, you need decide the method of superuser credentials setup.**
<div id="superuserCredentialsAzure">
  <Callout type="warning">
    Either you use the **default superuser credentials** or **custom superuser credentials**.
  </Callout>
</div>

**If you wish to use the default superuser credentials**, you can **skip the setup for custom super user credentials** and use the **default credentials** to log in to the Django Admin Panel (see below).


- **Default superuser credentials**: By default, Carrot creates a superuser with the following credentials:
  <div>
    - Username: `admin`
    - Password: `Password123!`
  </div>

- **Custom superuser credentials**: If you wish to create a new super user with custom credentials, do the following:
  <div>
    1. Add three more environment variables below to the Backend app's `Environment Variables`:
      <div>
        ```
          - SUPERUSER_DEFAULT_USERNAME : your_username
          - SUPERUSER_DEFAULT_EMAIL : your_email
          - SUPERUSER_DEFAULT_PASSWORD : your_password
        ```
      </div>
    2. Replace `your_username`, `your_email`, and `your_password` with your desired credentials.
  </div>

**The credentials will be applied after restarting the Backend app.**

---

**Now, do the following steps:**

1. **Restart your app for the environment variables to be applied**.

2. After that, Carrot will seed the app's database with the OMOP table and field names. 

3. Some **First Instances of Carrot** also need creating after the Backend app up and running. 

    **Follow these steps to create the first instances:**
    <div>
      1. Doing this by access the URL: `<backend-URL>/admin/`, log in using the [superuser credentials](#superuserCredentialsAzure).

      2. Then create first instance of the `Data partner`, `Dataset`, and `Project`.
    </div>

### Frontend app

Navigate to `Environment variables` section under `Settings` of your Frontend web app, then add the variables below:

<Table>
  <thead>
    <Tr>
      <Th>Key</Th>
      <Th>Description</Th>
    </Tr>
  </thead>
  <tbody>
    <Tr>
      <Td>
        `BACKEND_URL`
      </Td>
      <Td>
        The URL of the Backend web app.
      </Td>
    </Tr>
    <Tr>
      <Td>
        {" "}
        `NEXTAUTH_BACKEND_URL`
      </Td>
      <Td>
        The backend base endpoint URL where `Frontend` send auth requests to. Put here: `<backendUrl>/api/`
      </Td>
    </Tr>
    <Tr>
      <Td>
        {" "}
        `NEXTAUTH_SECRET`
      </Td>
      <Td>
        Used to encrypt the NextAuth.js JWT, and to hash email verification
        tokens. Choose a
        complex key for this. It is recommended to put this in the Key Vault.
      </Td>
    </Tr>
    <Tr>
      <Td>
        {" "}
        `NEXTAUTH_URL`
      </Td>
      <Td>The base URL where login and logout processes point to. Put here the URL of the Frontend web app</Td>
    </Tr>
  </tbody>
</Table>

### Function app

Navigate to `Environment variables` section under `Settings` of your Function app, then add the variables below:

<Table>
  <thead>
    <Tr>
      <Th>Key</Th>
      <Th>Description</Th>
    </Tr>
  </thead>
  <tbody>
    <Tr>
      <Td> `FUNCTIONS_WORKER_RUNTIME`</Td>
      <Td>
        The language or language stack of the worker runtime to load in the
        function app. Put here `python`.
      </Td>
    </Tr>
    <Tr>
      <Td> `DB_ENGINE`</Td>
      <Td>
        The database backend to use. Put here `django.db.backends.postgresql`.
      </Td>
    </Tr>
    <Tr>
      <Td>`DB_HOST` `DB_PORT` `DB_NAME` `DB_USER` `DB_PASSWORD`</Td>
      <Td>
        These settings (`port`, `host`, `name`, `user`, `password`) are required
        for PostgreSQL database connection. Put the details based on the setting
        of your Database. `DB_PASSWORD` is recommended to be put in the Key
        Vault.
      </Td>
    </Tr>
    <Tr>
      <Td>`RULES_QUEUE_NAME` `RULES_FILE_QUEUE_NAME` `WORKERS_UPLOAD_NAME`</Td>
      <Td>
        Matching name of queues in Azurite that `Workers` send messages about
        Rules actions triggers, Mapping Rules exports and ScanReport uploads,
        respectively.
      </Td>
    </Tr>
    <Tr>
      <Td>`STORAGE_CONN_STRING`</Td>
      <Td>
        The key to connect Backend and Azure local storage. Get this value by
        navigating to the Azure storage, then inside `Access keys` under
        `Security + Networking`, copy the `Connection string`. It is recommended
        to put this in the Key Vault.
      </Td>
    </Tr>
    <Tr>
      <Td>`AzureWebJobsStorage`</Td>
      <Td>Same value with the above.</Td>
    </Tr>
    <Tr>
      <Td>`SECRET_KEY`</Td>
      <Td>
        Same value with `SECRET_KEY` in Backend app. It is recommended to put
        this in the Key Vault.
      </Td>
    </Tr>
  </tbody>
</Table>

### Key vault

Set up your key vault by generate Keys/Secrets under `Objects` of your Key vault app.
Give your secret a name and add there the value of the secret.

You would also need to set up the `Access policies` of your Key vault: Add there Applications and Users, along with their permissions to access the vault. If you find it hard to search for a specific object while creating access policy, search by the object ID which can be generated by `Identity` under `Settings` of the application.

To use secrets in Key vault, change the value of the important environment variables to:

```bash
@Microsoft.KeyVault(VaultName=<key-vault-name>;SecretName=<secret-name>)
```

After that, you need to click `Pull reference values` which is located on top of the `Environment variables` page to apply the values in the Key vault to your environment.

</Steps>

## Testing

To test if Carrot is deployed successfully on Azure, open the URL of the Frontend app, then log in using admin credentials. If you can upload a scan report, add some manual and automatic Concepts, and download Mapping rules files successfuly, that's a sign that Carrot now can be used.

<Callout emoji="ðŸŽ‰">
  Congratulations on your first Carrot running on Azure!
</Callout>
