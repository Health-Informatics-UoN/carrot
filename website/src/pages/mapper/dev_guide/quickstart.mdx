import { Callout, Steps, Tabs } from "nextra/components";

# Developer Quickstart

This page will guide you through getting Carrot running locally.

Start by cloning [the Carrot Mapper repository](https://github.com/Health-Informatics-UoN/carrot-mapper)

## Prerequisites

- [Docker Desktop](https://www.docker.com/products/docker-desktop/)
- [MS Azure Storage Explorer](https://azure.microsoft.com/en-us/products/storage/storage-explorer/#Download-4)
- Vocabularies downloaded from [Athena](https://athena.ohdsi.org/). The guide for downloading can be found [here](https://github.com/OHDSI/Vocabulary-v5.0/wiki/General-Structure,-Download-and-Use).

## Getting Started

Below are steps to make Carrot up and running locally.

<Steps>

### OMOP schema and vocabs setting

You need a pre-seeded OMOP CDM database inside the database of Carrot.

To do this, add a folder named `vocabs` in the `root` directory of Carrot, then place there vocabulary files downloaded from Athena.

Thanks to [OMOP Lite](https://github.com/andyrae/omop-lite/pkgs/container/omop-lite) container, OMOP schema will be created and vocabularies will be loaded to Carrot's database, when the app's stack is running.

### Authentication setup for Azure functions

For local development, an authentication will be required when `api` container sends requests to `workers` container,.

To set this up, at the `app/workers` directory, add a folder named `Secrets`. Inside this folder, add a new file named `rulestrigger.json` with the following content:

```json
{
  "keys": [
    {
      "name": "default",
      "value": "rules_key",
      "encrypted": false
    }
  ]
}
```

### Environment variables setup for Super User Credentials.

Before running the Docker Compose, decide whether to use **Default Superuser Credentials** or **Custom Superuser Credentials** for logging into the Django Admin Panel.

<div id="superuserCredentials">
  - <u>**Default Super User Creation**</u>: By default, **Carrot creates a superuser** with the following credentials:
    <div>
    - **Username**: `admin` 
    - **Password**: `Password123!`
    </div>
  **Note:** If you wish to use these **default credentials**, you can **skip the setup** for **<u>custom super user credentials</u>**.
</div>

- <u>**Custom Superuser Credentials**</u>: If you **wish to create a new super user with custom credentials**, do the following:
  <div>
    1. Locate the `docker-compose.yml` file in the `root` directory of Carrot.
    2. Open the file and find the `api` service.
    3. Make changes in the `environment` section of the `api` service as follows:

      ```yaml
      environment:
        - SUPERUSER_DEFAULT_USERNAME : your_username
        - SUPERUSER_DEFAULT_EMAIL : your_email
        - SUPERUSER_DEFAULT_PASSWORD : your_password
      ```

    4. Replace `your_username`, `your_email`, and `your_password` with your desired credentials.
  </div>

<Callout type="warning">
  **Custom superuser credentials must be set before running Docker-Compose**. If not, the **default credentials created by the Carrot will be applied**.
</Callout>

Once you change the environment variables, **your custom super user credentials will be replaced with the default super user credentials**.
  <div>
    - Now you can use your **superuser credentials** to **log in to the Django Admin panel** (steps are mentioned later in this guide).
  </div>

### Warm up

At the `root` directory, run to command below to start the application stack using Docker compose.

```bash
docker compose up -d
```

This runs the database (`db`), Azurite emulator (`Azurite`), Azure functions (`workers`) and will build Carrot's backend (`api`) and frontend (`frontend`). This process will be on the background and take some time, but you can always check it through Docker Desktop app.

When all of containers, except `omop-lite`, are up and running successfully, Carrot's frontend and backend can be accessed through `http://localhost:3000/` and `http://localhost:8000/admin/` respectively.

- **However**, please complete the remaining steps, while containers are running, to make sure Carrot is running correctly.

More details about Docker compose's configuration can be found [here](configuration).

<Callout type="info">

The `omop-lite` container, whose task is creating `omop` schema on `db` and install vocabularies there, will be shut down automatically after successfully done its jobs.

</Callout>

<Callout type="info">

Docker will mount the `app/api` and `app/next-client-app` directories to its environment, so any changes in the code of the backend or frontend will be reflected in the running application.

</Callout>

### Initial data preparation

When running the Docker Compose for the first time, wait until the `omop-lite` container shuts down. **The execution time may vary depending of the size of the Vocabs folder**.

**Following the containers are up and running, Carrot will proceed to the next steps.**
  <div>
  - **Automatic Data Seeding**: The system will automatically populate the required database tables and data when the application starts.
  </div>

Since we already have the **Superuser credentials set up**, we can now proceed to the next steps.

### First instances creation

Create some first instances in Carrot app by logging to Django Admin panel `http://localhost:8000/admin/`.

1. You can **logging the Admin Panel** using the [superuser credentials](#superuserCredentials), either the **default credentials** or the **custom credentials** you configured earlier.
2. Once logged in, you will be presented with the Django Admin panel.
3. Following this order, fill out the required information to create new instance of `Data Partner`, `Dataset` and `Project`.

### Azure local storage setup

You need to set up an Azurite local storage for local development of Carrot

To do this, with the `workers` container in Docker Desktop is running, open `MS Azure Storage Explorer`, and create the following `queues` (under the tab `Storage Accounts - Emulator - Queues`) and `blob containers` (under the tab `Storage Accounts - Emulator - Blob Containers`).

<Tabs items={['Queues', 'Blob Containers']}>
  <Tabs.Tab>

```
rules-local
rules-exports-local
uploadreports-local
```

  </Tabs.Tab>
  <Tabs.Tab>

```
scan-reports
data-dictionaries
rules-exports
```

  </Tabs.Tab>
</Tabs>

### Check-in

You should now be able to access Carrot by logging in at `http://localhost:3000/` using your admin credentials created at step 4.

After log in, you will be presented with `Projects` page.

Try using Carrot by steps in the [user quickstart](/mapper/user_guide/quickstart) to see if Carrot is running correctly. If you can successfully upload a new scan report, create mapping rules, and finally can export the Mapping rules JSON. That's a sign that you have successfully install and run Carrot locally.

<Callout emoji="ðŸŽ‰">Congratulations on your first Carrot running!</Callout>

</Steps>

Since now on, to run Carrot locally, you can just run

```bash
docker compose up -d
```

and access `http://localhost:3000/`.

**What next?** Explore and try using Carrot with [user quickstart](/mapper/user_guide/quickstart).
