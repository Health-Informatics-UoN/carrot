import { Callout } from "nextra/components";
import HighlightedText from '@/components/HighlightedText';
import { Steps } from "nextra/components";


# Phase 3: Data Execution and Validation

## What is Carrot Transform?

**Carrot Transform** is a Python command-line tool that executes the transformation of data to the OMOP CDM, using the mapping rules generated with Carrot Mapper.

**Key Features:**
- **Local Deployment**: Runs within your data partner's environment next to the data, ensuring data security and privacy
- **Command Line Tool**: Can be easily integrated into data pipelines and automated workflows
- **Python-based**: Can be run from source or installed using pip
- **OMOP CDM Output**: Transforms your source data into the standardized OMOP Common Data Model format

**What Carrot Transform does:**
- Takes your mapping rules from Carrot Mapper
- Reads your original data files (CSV, SAS, database tables)
- Applies all the transformations you specified in the mapping rules
- Creates new files in the standard OMOP CDM format
- Validates the transformed data against OMOP CDM standards

**Why this step is important:**
- This is where your data actually gets converted from its current format to the standard OMOP CDM format
- It ensures your data follows all the OMOP CDM rules and standards
- It creates the final output that researchers can use for analysis
- It maintains data privacy by running locally within your environment

<Callout type="info">
  **Data Security**: Carrot Transform is designed to run locally within your environment, ensuring that sensitive healthcare data never leaves your secure infrastructure.
</Callout>

## Overview

The final phase of the Carrot ETL workflow focuses on executing the data transformation process. This phase combines all the work from the previous phases:

- **From Phase 1**: Your original source data files (`patients.csv`)
- **From Phase 2**: Your mapping rules JSON file (e.g., `Rules - Scan report test 2 - 6 - V2.json`)

Carrot Transform uses these inputs to actually transform your data into OMOP CDM format.

<Steps>

## Download and Set Up Carrot Transform

**Download Carrot Transform**

Download the latest release of Carrot Transform from GitHub:

1. Go to [https://github.com/Health-Informatics-UoN/carrot-transform](https://github.com/Health-Informatics-UoN/carrot-transform)
2. Download the latest release
3. Extract the files to a location on your computer (e.g., `~/Documents/carrot-transform/`)

**Install uv**

Carrot Transform uses `uv` to manage dependencies and run the tool. Install `uv` by following the [installation guide](https://carrot.ac.uk/transform/development#using-uv).

Once `uv` is installed, navigate to the carrot-transform directory you downloaded:

```bash
cd ~/Documents/carrot-transform
```

## Step 10: Execute Data Transformation with Sample Data

In this step, you'll use the files you've created in the previous phases to transform your data. Let's walk through a real example using the sample data.

### 10.1 Prepare Your Files

Before running Carrot Transform, make sure you have all the necessary files from the previous phases:

**From Phase 1 (WhiteRabbit):**
- Your original source data files (e.g., `patients.csv` from `WhiteRabbit_sample_input_csv/` folder)

**From Phase 2 (Carrot Mapper):**
- Your mapping rules JSON file that you downloaded from Carrot Mapper (e.g., `Rules - Scan report test 2 - 6 - V2.json`)

**For this example, let's assume you have:**
- Source data directory: `~/carrot-tutorial/WhiteRabbit_sample_input_csv/` containing `patients.csv`
- Mapping rules file: The JSON V2 file you downloaded from Carrot Mapper (e.g., `Rules - Scan report test 2 - 6 - V2.json`)
- Person file: `~/carrot-tutorial/WhiteRabbit_sample_input_csv/patients.csv` (this contains the person IDs)

### 10.2 Run the Transformation

**Example Command:**
```bash
uv run carrot-transform run_v2 mapstream \
  --rules-file examples/test/rules/v2.json \
  --output-dir output/ \
  --person-file examples/test/inputs/Demographics.csv \
  --input-dir examples/test/inputs/ \
  --omop-version "5.4"
```

**What each argument does:**
- `run_v2 mapstream`: Runs the version 2 transformation process using mapstream
- `--input-dir`: Directory containing your source CSV files (from Phase 1)
- `--rules-file`: The JSON V2 mapping rules file you downloaded from Carrot Mapper (from Phase 2)
- `--person-file`: The CSV file containing person/demographic data (first column should be person IDs)
- `--output-dir`: Where Carrot Transform will write the transformed OMOP CDM files
- `--omop-version`: Specifies the OMOP CDM version to use (e.g., "5.4")

<Callout type="info">
  **Note:** Make sure you're in the carrot-transform directory when running this command. Adjust the file paths to match your actual file locations.
</Callout>

### 10.3 What Happens During Transformation

When you run the command, Carrot Transform will:

1. **Load the mapping rules** - Reads your JSON rules file from Carrot Mapper
2. **Read your source data** - Loads the CSV files from your input directory
3. **Apply transformations** - Uses the mapping rules to convert your data fields to OMOP CDM format
4. **Generate OMOP files** - Creates TSV (tab-separated values) files for each OMOP CDM table
5. **Write output** - Saves all the transformed files to your output directory

**Expected Console Output:**
```
2025-11-24 10:44:36,718 - carrottransform.tools.logger - INFO - Detected v2.json format, using direct v2 parser...
2025-11-24 10:44:36,718 - carrottransform.tools.logger - INFO - Loaded v2 mapping rules from: examples/test/rules/v2.json in 0.01870 secs
2025-11-24 10:44:36,722 - carrottransform.tools.logger - INFO - Headers in Person file: ['PersonID', 'sex', 'date_of_birth', 'ethnicity']
2025-11-24 10:44:36,772 - carrottransform.tools.logger - INFO - Processing data...
2025-11-24 10:44:36,772 - carrottransform.tools.logger - INFO - Streaming input file: Symptoms.csv
2025-11-24 10:44:36,799 - carrottransform.tools.logger - INFO - Streaming input file: covid19_antibody.csv
2025-11-24 10:44:36,837 - carrottransform.tools.logger - INFO - Streaming input file: Demographics.csv
2025-11-24 10:44:36,903 - carrottransform.tools.logger - INFO - person_id stats: total loaded 1000, reject count 0
2025-11-24 10:44:36,903 - carrottransform.tools.logger - INFO - TARGET: condition_occurrence: output count 400
2025-11-24 10:44:36,903 - carrottransform.tools.logger - INFO - TARGET: measurement: output count 1000
2025-11-24 10:44:36,903 - carrottransform.tools.logger - INFO - TARGET: observation: output count 400
2025-11-24 10:44:36,903 - carrottransform.tools.logger - INFO - TARGET: person: output count 1000
2025-11-24 10:44:36,906 - carrottransform.tools.logger - INFO - V2 processing completed successfully in 0.20648 secs
```

### 10.4 Understanding the Output

After the transformation completes, check your output directory. You should see files like:

```
transform_output/
├── PERSON.tsv
├── OBSERVATION_PERIOD.tsv
├── VISIT_OCCURRENCE.tsv
├── CONDITION_OCCURRENCE.tsv
├── DRUG_EXPOSURE.tsv
├── PROCEDURE_OCCURRENCE.tsv
├── MEASUREMENT.tsv
├── OBSERVATION.tsv
├── metadata.json
└── transformation.log
```

**What each file contains:**

- **PERSON.tsv**: Patient demographic information (age, gender, race, ethnicity)
- **OBSERVATION_PERIOD.tsv**: Time periods during which the person was observed
- **VISIT_OCCURRENCE.tsv**: Healthcare visits and encounters
- **CONDITION_OCCURRENCE.tsv**: Diagnoses and conditions
- **DRUG_EXPOSURE.tsv**: Medications and drug exposures
- **PROCEDURE_OCCURRENCE.tsv**: Medical procedures performed
- **MEASUREMENT.tsv**: Clinical measurements (lab results, vital signs, etc.)
- **OBSERVATION.tsv**: Other clinical observations
- **metadata.json**: Information about the transformation process
- **transformation.log**: Detailed log of the transformation execution

### 10.5 Example Output: PERSON.tsv

Here's what a transformed `PERSON.tsv` file might look like (this is example data showing the structure):

```tsv
person_id	gender_concept_id	year_of_birth	month_of_birth	day_of_birth	birth_datetime	race_concept_id	ethnicity_concept_id	location_id	provider_id	care_site_id	person_source_value	gender_source_value	race_source_value	race_source_concept_id	ethnicity_source_value	ethnicity_source_concept_id
1	8507	1985	5	15		8527	0			M		M		
2	8532	1990	3	22		8527	0			F		F		
3	8507	1978	11	8		8527	0			M		M		
```

**What this shows:**
- **person_id**: Unique identifier for each person
- **gender_concept_id**: Standard OMOP concept ID for gender (8507 = Male, 8532 = Female)
- **year_of_birth, month_of_birth, day_of_birth**: Date of birth components
- **race_concept_id**: Standard OMOP concept ID for race
- **gender_source_value**: Original gender value from your source data (M, F)
- The transformed data now uses standard OMOP concept IDs instead of your original values

### 10.6 Example Output: CONDITION_OCCURRENCE.tsv

Here's what a transformed `CONDITION_OCCURRENCE.tsv` file might look like:

```tsv
condition_occurrence_id	person_id	condition_concept_id	condition_start_date	condition_start_datetime	condition_end_date	condition_end_datetime	condition_type_concept_id	stop_reason	provider_id	visit_occurrence_id	visit_detail_id	condition_source_value	condition_source_concept_id	condition_status_source_value	condition_status_concept_id
1	1	320128	2023-01-15	2023-01-15 00:00:00		2023-01-15	32020		1		I10			Active	
2	2	440540	2023-02-20	2023-02-20 00:00:00		2023-02-20	32020		2		E11.9			Active	
```

**What this shows:**
- **person_id**: Links to the person in the PERSON table
- **condition_concept_id**: Standard OMOP concept ID for the condition (320128 = Hypertension, 440540 = Diabetes)
- **condition_start_date**: When the condition was first recorded
- **condition_source_value**: Original diagnosis code from your source data (I10, E11.9)
- The transformation converted your original diagnosis codes to standard OMOP concept IDs

### 10.7 How the Transformation Works

Here's a simple example of how data flows through the transformation:

**Your Original Data (patients.csv):**
```csv
PersonID,Date,Gender,DOB,Diagnosis
1,2023-01-15,M,1985-05-15,I10
2,2023-02-20,F,1990-03-22,E11.9
```

**Your Mapping Rules (from Carrot Mapper):**
- `PersonID` → `person_id` in PERSON table
- `Gender` → `gender_concept_id` (M → 8507, F → 8532)
- `DOB` → `year_of_birth`, `month_of_birth`, `day_of_birth`
- `Diagnosis` → `condition_concept_id` in CONDITION_OCCURRENCE table (I10 → 320128, E11.9 → 440540)
- `Date` → `condition_start_date`

**Transformed Output (OMOP CDM format):**
- **PERSON.tsv**: Contains person demographics with standard concept IDs
- **CONDITION_OCCURRENCE.tsv**: Contains conditions with standard concept IDs and proper date formatting

The transformation applies all the mapping rules you created in Carrot Mapper to convert your source data into the standardized OMOP CDM format.

## Step 11: Verify Your Results

### 11.1 Check Output Files

1. Navigate to your output directory
2. Verify that the expected OMOP CDM table files were created
3. Open a few files to check that data looks correct

### 11.2 Review Sample Records

- Open `PERSON.tsv` and verify person records look correct
- Check that dates are in the correct format (YYYY-MM-DD)
- Verify that concept IDs are present (not just source values)
- Look at a few records from other tables to ensure transformations worked

### 11.3 Check the Log File

Review `transformation.log` for any warnings or errors. The log will show:
- Which files were processed
- How many records were generated for each table
- Any issues encountered during transformation

## What's Next?

Congratulations! You've successfully completed the Carrot ETL End-to-End Workflow. Your data has been transformed into OMOP CDM format and is ready for research use.

**What you've accomplished:**
- ✅ Profiled your data with WhiteRabbit
- ✅ Created mappings with Carrot Mapper
- ✅ Transformed your data with Carrot Transform
- ✅ Generated OMOP CDM-compliant output files

</Steps>

**Additional Resources:**
- [Troubleshooting and Best Practices](./troubleshooting)
- [Additional Resources](./resources)
- [Carrot Documentation](https://carrot.ac.uk/documentation)
- [OHDSI Community](http://forums.ohdsi.org/)

---

**Next:** Review the [Troubleshooting Guide](./troubleshooting) if you encounter any issues, or explore [Additional Resources](./resources) for more information.
