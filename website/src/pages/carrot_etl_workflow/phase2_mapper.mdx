import { Callout } from "nextra/components";
import HighlightedText from '@/components/HighlightedText';

# Phase 2: Data Transformation with Carrot Mapper

## What is Carrot Mapper?

**Carrot Mapper** is like a **translation service** for your data. 

Think of it this way:
- **WhiteRabbit** (Phase 1) told you what's in your data
- **Carrot Mapper** (Phase 2) helps you create a "dictionary" that translates your data into the standard OMOP CDM format
- **Carrot Transform** (Phase 3) uses that dictionary to actually do the translation

**What Carrot Mapper does:**
- Takes your scan report from WhiteRabbit
- Lets you map each field in your data to the standard OMOP format
- Creates rules for how to transform your data
- Generates a configuration file that Carrot Transform will use

**Why this step is important:**
- Your data might call a patient "patient_id" but OMOP calls it "person_id"
- Your dates might be in "MM/DD/YYYY" format but OMOP needs "YYYY-MM-DD"
- Your diagnosis codes might be in one format but need to be in another
- Carrot Mapper helps you specify all these translations

## Overview

The second phase of the Carrot ETL workflow focuses on using Carrot Mapper to create data mappings and transformation rules. This phase uses the insights gained from WhiteRabbit profiling and turns them into ETL configurations that can convert your source data into OMOP CDM format.

## Step 4: Carrot Mapper Setup

<Callout type="warning">
  **Admin Configuration Required:** Carrot Mapper requires initial setup through the admin backend. This includes creating projects, configuring data sources, and setting up user permissions. Please contact your system administrator to ensure the Carrot Mapper environment is properly configured before proceeding with this tutorial.
</Callout>

### 4.1 Access Carrot Mapper

1. Navigate to your Carrot Mapper instance
2. Log in with appropriate credentials
3. Verify you have access to the configured project

<Callout type="info">
  **Note:** Carrot Mapper is accessed through a web interface. The project and data source configuration should already be set up by your administrator.
</Callout>

## Step 5: Upload Scan Report

### 5.1 Prepare Files for Upload

1. Ensure you have:
   - `ScanReport.xlsx` from WhiteRabbit
   - Required permissions and access

<Callout type="info">
  **Data Dictionary (Optional):** A data dictionary is not mandatory for the upload process. If you have a data dictionary that matches your scan report, you can upload it to provide additional context about your data fields. However, for this tutorial, we'll proceed without a data dictionary to demonstrate the upload process.
</Callout>


### 5.2 Upload Process

<div style={{ textAlign: "center", marginTop: "24px", marginBottom: "32px" }}>
  <figure style={{ margin: "0" }}>
    <img 
      src="/docs/Scan_Report_upload.png" 
      alt="Carrot Mapper Scan Report Upload Interface" 
      width="100%"
      height="auto"
      style={{ 
        maxWidth: "800px", 
        border: "3px solid #007acc", 
        borderRadius: "16px",
        padding: "12px",
        boxShadow: "0 8px 16px rgba(0,0,0,0.15)",
        backgroundColor: "#ffffff"
      }} 
    />
    <figcaption style={{ 
      marginTop: "16px", 
      fontStyle: "italic", 
      color: "#333",
      fontSize: "16px",
      fontWeight: "600"
    }}>
      Figure: Carrot Mapper Scan Report Upload Interface
    </figcaption>
  </figure>
</div>

1. In Carrot Mapper, locate the upload section
2. Upload your `ScanReport.xlsx` file
3. (Optional) If you have a data dictionary that matches your scan report, you can upload it here. For this tutorial, we'll skip the data dictionary upload.
4. Verify the scan report is properly loaded
5. Review any validation messages or warnings

<Callout type="info">
  **If you do use a data dictionary:** For detailed requirements on data formatting and CSV file structure, see the [Data Standards](/standards) page.
</Callout>

## Step 6: Begin Data Mapping

Once you've uploaded your scan report (and optionally a data dictionary), the system processes the files and makes them ready for mapping. Here's what you do next:

### 6.1 Access Your Uploaded Scan Report

1. **Go to the "Scan Reports" page** in Carrot Mapper
2. **Find and click on your uploaded scan report**
3. **This opens the scan report detail page**

### 6.2 Map Individual CSV Files

On the scan report detail page, you'll see the CSV files from your data. For this tutorial, you should see:
- `patients.csv`

**Let's start mapping:**

#### Map patients.csv
1. **Click "Edit Table" on patients.csv** - this opens the mapping interface

<div style={{ textAlign: "center", marginTop: "24px", marginBottom: "32px" }}>
  <figure style={{ margin: "0" }}>
    <img 
      src="/docs/Editing Scan Report.png" 
      alt="Carrot Mapper Edit Table Interface for patients.csv" 
      width="100%"
      height="auto"
      style={{ 
        maxWidth: "800px", 
        border: "3px solid #007acc", 
        borderRadius: "16px",
        padding: "12px",
        boxShadow: "0 8px 16px rgba(0,0,0,0.15)",
        backgroundColor: "#ffffff"
      }} 
    />
    <figcaption style={{ 
      marginTop: "16px", 
      fontStyle: "italic", 
      color: "#333",
      fontSize: "16px",
      fontWeight: "600"
    }}>
      Figure: Edit Table Interface - Configuring Person ID and Date Event for patients.csv
    </figcaption>
  </figure>
</div>

2. **Set up the key fields** - you'll see dropdown menus for:
   - **Person ID**: Pick the field with patient identifiers (like "PersonID")
   - **Date Event**: Pick the field with event dates (like "BIRTHDATE, DEATHDATE")
3. **Click "Save"** to confirm your choices


### 6.3 Concept Reuse Configuration

During the mapping process, you'll be asked:

**"Do you want to trigger the reuse of existing concepts?"**

**Choose "Yes"** if you want to:
- Reuse concepts from other scan reports in the same dataset
- Let the system automatically match concepts based on field names and values
- Speed up the mapping process for similar data

<Callout type="info">
  **Note:** Enabling concept reuse may make the auto-mapping process take longer to run, but it will provide more consistent mappings across your datasets.
</Callout>

### 6.4 Auto-Mapping Process

Once you've configured the CSV file:
- The system automatically starts mapping it
- It uses the field settings you just configured
- The process looks at your data and suggests OMOP CDM mappings
- You can review and tweak these suggestions later

<div style={{ textAlign: "center", marginTop: "24px", marginBottom: "32px" }}>
  <figure style={{ margin: "0" }}>
    <img 
      src="/docs/Mapping in Progress.png" 
      alt="Carrot Mapper Auto-Mapping in Progress" 
      width="100%"
      height="auto"
      style={{ 
        maxWidth: "800px", 
        border: "3px solid #007acc", 
        borderRadius: "16px",
        padding: "12px",
        boxShadow: "0 8px 16px rgba(0,0,0,0.15)",
        backgroundColor: "#ffffff"
      }} 
    />
    <figcaption style={{ 
      marginTop: "16px", 
      fontStyle: "italic", 
      color: "#333",
      fontSize: "16px",
      fontWeight: "600"
    }}>
      Figure: Auto-Mapping Process in Progress - Jobs Running
    </figcaption>
  </figure>
</div>

**What you'll see while it's running:**
- Spinning orange circles in the "Jobs Progress" column show it's working
- The system looks through your data and creates initial mappings
- This might take a few minutes depending on how much data you have
- You can check progress using the "Refresh Jobs Progress" button

<div style={{ textAlign: "center", marginTop: "24px", marginBottom: "32px" }}>
  <figure style={{ margin: "0" }}>
    <img 
      src="/docs/Mapping Jobs Complete.png" 
      alt="Carrot Mapper Auto-Mapping Complete" 
      width="100%"
      height="auto"
      style={{ 
        maxWidth: "800px", 
        border: "3px solid #007acc", 
        borderRadius: "16px",
        padding: "12px",
        boxShadow: "0 8px 16px rgba(0,0,0,0.15)",
        backgroundColor: "#ffffff"
      }} 
    />
    <figcaption style={{ 
      marginTop: "16px", 
      fontStyle: "italic", 
      color: "#333",
      fontSize: "16px",
      fontWeight: "600"
    }}>
      Figure: Auto-Mapping Process Complete - Ready for Review
    </figcaption>
  </figure>
</div>

**When it's done:**
- The spinning circles disappear and get replaced with green checkmarks
- Your CSV files show as ready for review and editing
- You can click "Edit Table" to look at and adjust the mappings
- The system has created initial field mappings based on your Person ID and Date Event choices

### 6.5 Manual-Mapping Process

When you upload a scan report and data dictionary for the very first time, you'll need to map your data manually. This is because we dont have existing OMOP concepts for the new Scan Report and/or Data Dictionary we are uploading.
Here's how the manual-mapping process works in Carrot Mapper:

#### 1. Navigate to an Uploaded File

- Open one of your uploaded source files in this case `patient.csv` from the file list.
- You'll see a preview of its contents. These are the columns and some sampled rows from your source data.
- Click **"patients.csv"** name so we can access the mapping interface for our data.
<div style={{ textAlign: "center", marginTop: "24px", marginBottom: "32px" }}>
  <figure style={{ margin: "0" }}>
    <img 
      src="/docs/Navigate to Patient data.png" 
      alt="Carrot Mapper Auto-Mapping Complete" 
      width="100%"
      height="auto"
      style={{ 
        maxWidth: "800px", 
        border: "3px solid #007acc", 
        borderRadius: "16px",
        padding: "12px",
        boxShadow: "0 8px 16px rgba(0,0,0,0.15)",
        backgroundColor: "#ffffff"
      }} 
    />
    <figcaption style={{ 
      marginTop: "16px", 
      fontStyle: "italic", 
      color: "#333",
      fontSize: "16px",
      fontWeight: "600"
    }}>
      Figure: Getting ready to begin manual mapping
    </figcaption>
  </figure>
</div>


#### 2. Using AI Suggestions to Map Fields

Carrot Mapper provides AI-powered suggestions based on Athena to help you quickly map your data values to OMOP concepts. Below is how we can achieve it:

We first navigate into a field that we need to do the mapping, in this case we shall use the Gender as an example. When we navigate inside data, we shall find two rows, `F` and `M`.
`F` menans "Female" and `M` means "Male". At this stage, we shall navigate to the column that says `AI Suggestions` and click on the `Suggestion` button. Lets beging with `M` row.
After clicking the suggestions button, we get a drop down list with domains for us to select from as seen below.

<div style={{ textAlign: "center", marginTop: "14px", marginBottom: "22px" }}>
  <figure style={{ margin: "0" }}>
    <img 
      src="/docs/Selecting Domain.png" 
      alt="Carrot Mapper Auto-Mapping Complete" 
      width="100%"
      height="auto"
      style={{ 
        maxWidth: "800px", 
        border: "3px solid #007acc", 
        borderRadius: "16px",
        padding: "12px",
        boxShadow: "0 8px 16px rgba(0,0,0,0.15)",
        backgroundColor: "#ffffff"
      }} 
    />
    <figcaption style={{ 
      marginTop: "16px", 
      fontStyle: "italic", 
      color: "#333",
      fontSize: "16px",
      fontWeight: "600"
    }}>
      Figure: Selecting a domain for mapping
    </figcaption>
  </figure>
</div>

Since we are mapping gender, we shall select the gender domain for this mapping.
Once we click that, a modal will pop up with suggestions on the best OMOP concept to select from the AI suggestions.
From the modal, we see that we have an accuracy score which guides us on the best OMOP concept to select from the modal. Before selecting the concept, please vefiry if the concept name matches what we expect. In this case our concept name must be male. 
We then click add and mapper will apply the OMOP concept we selected. After selecting, we shall see a green toast message confirming the successful addintion `OMOP Concept successfully added.`
A blue concept tag appers on the table row under the concept column showing the mapped OMOP concept. Incase we wanted to change the OMOP concept, the blue concept tag has an `X` button that
we can use to remove the concept and we can now be able to add another one.


#### 3. Manually Mapping Data Values (Alternative Method)

If AI suggestions don't appear or you need to map to a specific OMOP concept that wasn't suggested, you can manually enter OMOP concept codes:

1. **Locate the value** you want to map in the table.
2. **Click into the text box** to the left of the **"Add"** button.
3. **Type the OMOP concept code** you want to assign (e.g., `8532` for Female or `8507` for Male).
4. **Click "Add"** - If successful, you'll see a confirmation banner and a blue concept tag in the table.

**Example: Manual Gender Mapping**

- Navigate to the **gender** field.
- For the `F` row, type `8532` in the text box and click **"Add"**.
- For the `M` row, type `8507` in the text box and click **"Add"**.
- After adding, a green banner confirms each mapping, and the OMOP concept appears in the table row.

#### 4. Reviewing and Adjusting Mappings

- To review your new mappings, go to the **Rules** tab.
- You'll see that new mapping rules have been automatically created—one for each value you mapped (e.g., F → Female, M → Male).
- These rules define how your source data will be translated in the OMOP CDM.

#### 5. Removing a Concept (Optional)

- To delete a mapping, click the grey **x** on the right of the concept tag within the table.
- Return to the **Rules** page, and you'll see that the mapping rule for this value has also been deleted.

> **Tip:** Start with AI suggestions for faster mapping, then manually adjust any values that need different concepts. You can mix both methods—use AI suggestions where they're accurate, and manually map values where you need more control.

Now, you're ready to complete the mapping for all required values and proceed to view the generated rules and mapping diagrams!




## Step 7: Review Generated Rules and Mapping Diagram

Once the auto-mapping is done, you can check out the rules it created and see how your mappings look.

### 7.1 View Generated Rules

1. **Click the "Rules" tab** in your scan report
2. **Check out the generated rules** - you'll see all the transformation rules that were automatically created
3. **Look at the details** - each rule shows how your source data fields are mapped to OMOP CDM fields

<div style={{ textAlign: "center", marginTop: "24px", marginBottom: "32px" }}>
  <figure style={{ margin: "0" }}>
    <img 
      src="/docs/View Generated Rules.png" 
      alt="Carrot Mapper Generated Rules View" 
      width="100%"
      height="auto"
      style={{ 
        maxWidth: "800px", 
        border: "3px solid #007acc", 
        borderRadius: "16px",
        padding: "12px",
        boxShadow: "0 8px 16px rgba(0,0,0,0.15)",
        backgroundColor: "#ffffff"
      }} 
    />
    <figcaption style={{ 
      marginTop: "16px", 
      fontStyle: "italic", 
      color: "#333",
      fontSize: "16px",
      fontWeight: "600"
    }}>
      Figure: Generated Rules View - Field Mappings and OMOP CDM Transformations
    </figcaption>
  </figure>
</div>

### 7.2 View Mapping Diagram

1. **Click "View Map Diagram"** - it's at the top left of the Rules tab
2. **See your mappings visually** - this shows a diagram of how your source data connects to the OMOP CDM structure
3. **Understand the relationships** - the diagram helps you see the overall data flow and how fields connect

<div style={{ textAlign: "center", marginTop: "24px", marginBottom: "32px" }}>
  <figure style={{ margin: "0" }}>
    <img 
      src="/docs/Mapping Diagram.png" 
      alt="Carrot Mapper Mapping Diagram Visualization" 
      width="100%"
      height="auto"
      style={{ 
        maxWidth: "800px", 
        border: "3px solid #007acc", 
        borderRadius: "16px",
        padding: "12px",
        boxShadow: "0 8px 16px rgba(0,0,0,0.15)",
        backgroundColor: "#ffffff"
      }} 
    />
    <figcaption style={{ 
      marginTop: "16px", 
      fontStyle: "italic", 
      color: "#333",
      fontSize: "16px",
      fontWeight: "600"
    }}>
      Figure: Mapping Diagram - Visual Representation of Data Flow and Field Relationships
    </figcaption>
  </figure>
</div>

<Callout type="info">
  **Tip:** The mapping diagram is really helpful for understanding complex data relationships and making sure your mappings work with OMOP CDM requirements.
</Callout>

### 7.3 Review Rules in Review Tab

1. **Click the "Review Rules" tab** in your scan report
2. **Check out your rules** - this gives you another way to look at your transformation rules
3. **Double-check your mappings** - use this tab to make sure everything looks right before downloading

## Step 8: Download Mapping Configuration

Once you've checked out your rules and mapping diagram, you can download your mapping configuration to use with Carrot Transform.

### 8.1 Access Actions Menu

1. **Click the "Actions" button** - it's in the top right of the Rules tab
2. **See what's available** - this opens a dropdown menu with download and management options

<div style={{ textAlign: "center", marginTop: "24px", marginBottom: "32px" }}>
  <figure style={{ margin: "0" }}>
    <img 
      src="/docs/Actions Button.png" 
      alt="Carrot Mapper Actions Menu" 
      width="100%"
      height="auto"
      style={{ 
        maxWidth: "800px", 
        border: "3px solid #007acc", 
        borderRadius: "16px",
        padding: "12px",
        boxShadow: "0 8px 16px rgba(0,0,0,0.15)",
        backgroundColor: "#ffffff"
      }} 
    />
    <figcaption style={{ 
      marginTop: "16px", 
      fontStyle: "italic", 
      color: "#333",
      fontSize: "16px",
      fontWeight: "600"
    }}>
      Figure: Actions Menu - Download Options and Scan Report Management
    </figcaption>
  </figure>
</div>

### 8.2 Download Mapping Configuration

**Available Download Options:**

**Downloads Section:**
- **Mapping JSON**: Downloads your mapping configuration in JSON format (this is what Carrot Transform needs)
- **Mapping JSON V2**: Downloads your mapping configuration in JSON V2 format (enhanced version)
- **Mapping CSV**: Downloads your mapping configuration in CSV format

**Scan Report Section:**
- **Export**: Exports the scan report data
- **Delete**: Deletes the scan report (be careful with this one)

### 8.3 Download Process

**For Mapping JSON and Mapping CSV:**
1. **Click "Mapping JSON" or "Mapping CSV"** - pick your preferred format
2. **The system starts preparing your file** - it gets your mapping configuration ready
3. **You'll be taken to the Downloads tab** - this happens automatically
4. **Watch the progress** - keep an eye on it until it's ready
5. **Download to your computer** - once it's ready, click to download it

**For Mapping JSON V2:**
1. **Click "Mapping JSON V2"** - this starts generating the Mapping Rules JSON V2
2. **The system processes your mappings** - it creates the enhanced JSON V2 format
3. **You'll be taken to the Downloads tab** - this happens automatically
4. **Watch the generation progress** - keep an eye on it until it's done

<div style={{ textAlign: "center", marginTop: "24px", marginBottom: "32px" }}>
  <figure style={{ margin: "0" }}>
    <img 
      src="/docs/Trigger Mapping Rules Generation.png" 
      alt="Carrot Mapper Mapping Rules Generation in Progress" 
      width="100%"
      height="auto"
      style={{ 
        maxWidth: "800px", 
        border: "3px solid #007acc", 
        borderRadius: "16px",
        padding: "12px",
        boxShadow: "0 8px 16px rgba(0,0,0,0.15)",
        backgroundColor: "#ffffff"
      }} 
    />
    <figcaption style={{ 
      marginTop: "16px", 
      fontStyle: "italic", 
      color: "#333",
      fontSize: "16px",
      fontWeight: "600"
    }}>
      Figure: Downloads Tab - Mapping Rules JSON V2 Generation in Progress
    </figcaption>
  </figure>
</div>

5. **Download to your computer** - once generation is complete, click to download the JSON V2 file

<div style={{ textAlign: "center", marginTop: "24px", marginBottom: "32px" }}>
  <figure style={{ margin: "0" }}>
    <img 
      src="/docs/Download Mapping Rules.png" 
      alt="Carrot Mapper Download Mapping Rules" 
      width="100%"
      height="auto"
      style={{ 
        maxWidth: "800px", 
        border: "3px solid #007acc", 
        borderRadius: "16px",
        padding: "12px",
        boxShadow: "0 8px 16px rgba(0,0,0,0.15)",
        backgroundColor: "#ffffff"
      }} 
    />
    <figcaption style={{ 
      marginTop: "16px", 
      fontStyle: "italic", 
      color: "#333",
      fontSize: "16px",
      fontWeight: "600"
    }}>
      Figure: Ready to download your Mapping Rules JSON V2 file
    </figcaption>
  </figure>
</div>

<Callout type="info">
  **Note:** The download process might take a few minutes depending on how big your mapping configuration is. For Mapping JSON V2, there's an extra generation step that could take longer. The Downloads tab will show you the progress and let you know when the file is ready.
</Callout>

## What's Next?

Congratulations! You've successfully completed the Carrot Mapper workflow. You now have:

- ✅ Uploaded your scan report and data dictionary
- ✅ Configured field mappings for your CSV files
- ✅ Generated transformation rules automatically
- ✅ Reviewed your mappings and rules
- ✅ Downloaded your mapping configuration (JSON V2)

Your mapping configuration file is now ready to use with **Carrot Transform** in the next phase of the ETL workflow.

---

**Next:** [Phase 3: Data Execution with Carrot Transform](./phase3_execution) - Use your mapping configuration to transform your data into OMOP CDM format
